<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEPROBA Task Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script> <!-- For data labels -->
    <script src="https://code.responsivevoice.org/responsivevoice.js"></script> <!-- Voice support -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary-green: #006400; --primary-red: #B22222; --primary-black: #1C2526; --primary-white: #F5F6F5; --accent-blue: #4682B4; --high-contrast-text: #1a1a1a; --high-contrast-bg: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, var(--primary-green), var(--accent-blue)); min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px 30px; margin-bottom: 30px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: center; }
        .logo img { max-height: 60px; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-switcher { padding: 8px 16px; background: linear-gradient(45deg, var(--primary-green), var(--accent-blue)); color: var(--primary-white); border: none; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .user-avatar { width: 45px; height: 45px; background: linear-gradient(45deg, var(--primary-green), var(--accent-blue)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary-white); font-weight: bold; font-size: 18px; }
        .navigation { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 15px; padding: 15px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
        .nav-tabs { display: flex; gap: 10px; flex-wrap: wrap; }
        .nav-tab { padding: 12px 24px; background: transparent; border: 2px solid #ddd; border-radius: 25px; cursor: pointer; transition: all 0.3s ease; font-weight: 500; color: var(--primary-black); }
        .nav-tab.active { background: linear-gradient(45deg, var(--primary-green), var(--accent-blue)); color: var(--primary-white); border-color: transparent; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 100, 0, 0.3); }
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .dashboard-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease; }
        .dashboard-card:hover { transform: translateY(-5px); }
        .card-title { font-size: 22px; font-weight: bold; color: var(--primary-black); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        .stat-item { text-align: center; padding: 20px; background: linear-gradient(135deg, var(--primary-green), var(--accent-blue)); border-radius: 15px; color: var(--primary-white); animation: fadeIn 1s ease-in-out; }
        .stat-number { font-size: 32px; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 14px; opacity: 0.9; }
        .task-item { padding: 20px; border-left: 4px solid var(--primary-green); background: var(--primary-white); border-radius: 10px; margin-bottom: 15px; transition: all 0.3s ease; position: relative; }
        .task-item:hover { background: #e9ecef; border-left-color: var(--accent-blue); }
        .task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .task-title { font-weight: 600; color: var(--primary-black); font-size: 16px; }
        .task-actions { display: flex; gap: 10px; margin-top: 15px; }
        .task-status { padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; }
        .status-not-started { background: var(--primary-red); color: var(--primary-white); }
        .status-in-progress { background: #fdcb6e; color: #e17055; }
        .status-completed { background: var(--accent-blue); color: var(--primary-white); }
        .status-done { background: var(--primary-green); color: var(--primary-white); }
        .task-meta { display: flex; gap: 20px; font-size: 14px; color: var(--primary-black); margin-bottom: 10px; flex-wrap: wrap; }
        .btn { padding: 8px 16px; border: none; border-radius: 20px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; font-size: 12px; }
        .btn-primary { background: linear-gradient(45deg, var(--primary-green), var(--accent-blue)); color: var(--primary-white); }
        .btn-secondary { background: #e9ecef; color: var(--primary-black); }
        .btn-success { background: var(--primary-green); color: var(--primary-white); }
        .btn-warning { background: #fdcb6e; color: #e17055; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary-black); }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px 16px; border: 2px solid #ddd; border-radius: 10px; font-size: 14px; transition: border-color 0.3s ease; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary-green); }
        .progress-bar { width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(45deg, var(--primary-green), var(--accent-blue)); transition: width 0.3s ease; }
        .page { display: none; }
        .page.active { display: block; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: var(--primary-green); color: var(--primary-white); border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); z-index: 1000; transform: translateX(400px); transition: transform 0.3s ease; }
        .notification.show { transform: translateX(0); }
        .notification.error { background: var(--primary-red); }
        .notification.warning { background: #fdcb6e; color: #e17055; }
        .task-comments { margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6; }
        .comment { background: var(--primary-white); padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 14px; }
        .comment-author { font-weight: 600; color: var(--primary-green); margin-bottom: 5px; }
        .add-comment { display: flex; gap: 10px; margin-top: 10px; }
        .comment-input { flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; }
        .full-width { grid-column: 1 / -1; }
        .task-assignment { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .assignment-alert { color: #856404; font-weight: 500; margin-bottom: 10px; }
        .filter-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: var(--primary-white); padding: 20px; border-radius: 10px; max-width: 500px; width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { cursor: pointer; font-size: 20px; }
        .hierarchy-view { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .hierarchy-level { margin-left: 0; margin-bottom: 20px; }
        .hierarchy-level.level-1 { margin-left: 20px; }
        .hierarchy-level.level-2 { margin-left: 40px; }
        .hierarchy-level.level-3 { margin-left: 60px; }
        .hierarchy-level.level-4 { margin-left: 80px; }
        .hierarchy-level.level-5 { margin-left: 100px; }
        .hierarchy-item { background: var(--primary-white); padding: 15px 20px; border-radius: 10px; border-left: 4px solid var(--primary-green); margin-bottom: 10px; position: relative; }
        .hierarchy-item::before { content: ""; position: absolute; left: -25px; top: 50%; width: 20px; height: 2px; background: #ddd; }
        .role-indicator { display: inline-block; padding: 3px 8px; background: var(--primary-green); color: var(--primary-white); border-radius: 12px; font-size: 11px; font-weight: 500; margin-left: 10px; }
        [data-tooltip]:hover::after { content: attr(data-tooltip); position: absolute; top: 100%; left: 50%; transform: translateX(-50%); background: var(--primary-black); color: var(--primary-white); padding: 5px 10px; border-radius: 5px; font-size: 12px; white-space: nowrap; z-index: 10; }
        [high-contrast] .dashboard-card, [high-contrast] .hierarchy-item { background: var(--high-contrast-bg); color: var(--high-contrast-text); border: 2px solid var(--high-contrast-text); }
        .file-preview { max-width: 200px; max-height: 200px; margin-top: 10px; object-fit: contain; }
        .file-list { margin-top: 10px; }
        .file-item { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .file-item a { color: var(--accent-blue); text-decoration: underline; }
        .chart-container { position: relative; height: 300px; margin-top: 20px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media (max-width: 768px) { .main-content { grid-template-columns: 1fr; } .stats-grid { grid-template-columns: 1fr; } .header { flex-direction: column; gap: 15px; text-align: center; } .task-actions { flex-direction: column; gap: 5px; } }
        @media (max-width: 480px) { .container { padding: 10px; } .form-input, .form-select, .form-textarea { font-size: 16px; } .btn { padding: 10px 20px; font-size: 14px; } .task-meta { flex-direction: column; gap: 5px; } .filter-group { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo"><img src="assets/image/logo.svg" alt="KEPROBA Logo" aria-label="KEPROBA Logo"></div>
            <div class="user-info">
                <button class="user-switcher" onclick="switchUser()" data-tooltip="Switch to another user">Switch User</button>
                <div><div style="font-weight: 600;" id="current-user-name">Floice Mukabana</div><div style="font-size: 14px; color: var(--primary-black);" id="current-user-role">Chief Executive Officer</div></div>
                <div class="user-avatar" id="current-user-avatar">FM</div>
            </div>
        </header>
        <nav class="navigation">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showPage('dashboard')" role="tab" aria-selected="true" aria-controls="dashboard" data-tooltip="View your task overview">📊 Dashboard</button>
                <button class="nav-tab" onclick="showPage('tasks')" role="tab" aria-selected="false" aria-controls="tasks" data-tooltip="View tasks you created">✅ My Tasks</button>
                <button class="nav-tab" onclick="showPage('create')" role="tab" aria-selected="false" aria-controls="create" data-tooltip="Create a new task">➕ Create Task</button>
                <button class="nav-tab" onclick="showPage('assigned')" role="tab" aria-selected="false" aria-controls="assigned" data-tooltip="View tasks assigned to you">📋 Assigned to Me</button>
                <button class="nav-tab" onclick="showPage('hierarchy')" role="tab" aria-selected="false" aria-controls="hierarchy" data-tooltip="View organizational hierarchy">🏢 Organization</button>
                <button class="nav-tab" onclick="showPage('performance')" role="tab" aria-selected="false" aria-controls="performance" data-tooltip="View performance metrics">📈 Performance</button>
                <button class="nav-tab" onclick="showPage('help')" role="tab" aria-selected="false" aria-controls="help" data-tooltip="View tutorials and FAQs">❓ Help</button>
                <button class="btn btn-secondary" onclick="toggleHighContrast()" data-tooltip="Toggle high contrast mode">Toggle High Contrast</button>
            </div>
        </nav>
        <div id="login" class="page active">
            <div class="dashboard-card full-width">
                <h2 class="card-title">🔒 Login</h2>
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="form-group"><label class="form-label" for="login-user">User</label><select class="form-select" id="login-user" required aria-required="true"></select></div>
                    <button type="submit" class="btn btn-primary">Login</button>
                </form>
            </div>
        </div>
        <div id="dashboard" class="page">
            <div class="main-content">
                <div class="dashboard-card">
                    <h2 class="card-title">📈 My Overview</h2>
                    <div class="filter-group"><select class="form-select" id="dashboard-filter" onchange="updateDashboard()"></select></div>
                    <div class="stats-grid" id="dashboard-stats"></div>
                </div>
                <div class="dashboard-card">
                    <h2 class="card-title">🎯 Recent Activities</h2>
                    <div id="recent-activities"></div>
                </div>
            </div>
        </div>
        <div id="tasks" class="page">
            <div class="dashboard-card full-width">
                <h2 class="card-title">✅ My Tasks & Delegated Items</h2>
                <div class="filter-group">
                    <input type="text" class="form-input" id="task-search" placeholder="Search tasks..." oninput="updateTasksView()">
                    <select class="form-select" id="tasks-filter" onchange="updateTasksView()"></select>
                    <select class="form-select" id="department-filter" onchange="updateTasksView()"></select>
                    <select class="form-select" id="priority-filter" onchange="updateTasksView()"></select>
                    <select class="form-select" id="sort-by" onchange="updateTasksView()"></select>
                </div>
                <div id="my-tasks-list"></div>
            </div>
        </div>
        <div id="assigned" class="page">
            <div class="dashboard-card full-width">
                <h2 class="card-title">📋 Tasks Assigned to Me</h2>
                <div class="filter-group">
                    <input type="text" class="form-input" id="assigned-task-search" placeholder="Search tasks..." oninput="updateAssignedTasksView()">
                    <select class="form-select" id="assigned-filter" onchange="updateAssignedTasksView()"></select>
                    <select class="form-select" id="assigned-department-filter" onchange="updateAssignedTasksView()"></select>
                    <select class="form-select" id="assigned-priority-filter" onchange="updateAssignedTasksView()"></select>
                </div>
                <div id="assigned-tasks-notice"></div>
                <div id="assigned-tasks-list"></div>
            </div>
        </div>
        <div id="create" class="page">
            <div class="dashboard-card full-width">
                <h2 class="card-title">➕ Create New Task</h2>
                <form id="task-form" onsubmit="createTask(event)">
                    <div class="form-group"><label class="form-label" for="task-title">Task Title*</label><input type="text" class="form-input" id="task-title" placeholder="Enter task title..." required aria-required="true"></div>
                    <div class="form-group"><label class="form-label" for="task-description">Description</label><textarea class="form-textarea" rows="4" id="task-description" placeholder="Describe the task in detail..."></textarea></div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group"><label class="form-label" for="task-assignee">Assign To*</label><select class="form-select" id="task-assignee" required aria-required="true"></select></div>
                        <div class="form-group"><label class="form-label" for="task-priority">Priority</label><select class="form-select" id="task-priority"></select></div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group"><label class="form-label" for="task-due-date">Due Date</label><input type="date" class="form-input" id="task-due-date"></div>
                        <div class="form-group"><label class="form-label" for="task-department">Department</label><select class="form-select" id="task-department"></select></div>
                    </div>
                    <div class="form-group"><label class="form-label" for="task-dependencies">Dependencies</label><select class="form-select" id="task-dependencies" multiple></select></div>
                    <div class="form-group"><label class="form-label" for="task-files">Attach Files</label><input type="file" class="form-input" id="task-files" multiple accept=".pdf,.txt,.jpg,.png"></div>
                    <div class="form-group"><label class="form-label"><input type="checkbox" id="task-milestone"> Mark as Milestone</label></div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 20px; padding: 12px 24px;">Create Task</button>
                </form>
            </div>
        </div>
        <div id="hierarchy" class="page">
            <div class="hierarchy-view">
                <h2 class="card-title">🏢 Organizational Hierarchy & Task Distribution</h2>
                <div id="hierarchy-content"></div>
            </div>
        </div>
        <div id="performance" class="page">
            <div class="dashboard-card full-width">
                <h2 class="card-title">📈 Performance Overview</h2>
                <div class="filter-group">
                    <select class="form-select" id="performance-user-filter" onchange="updatePerformanceView()"></select>
                    <select class="form-select" id="performance-time-filter" onchange="updatePerformanceView()"></select>
                </div>
                <div id="performance-stats"></div>
                <div class="chart-container"><canvas id="task-trends-chart"></canvas></div>
            </div>
        </div>
        <div id="help" class="page">
            <div class="dashboard-card full-width">
                <h2 class="card-title">❓ Help & Tutorials</h2>
                <div><h3>Getting Started</h3><p>Use voice commands or assistance to navigate. Say 'Help' for options.</p><h3>Voice Commands</h3><p>Say: 'Show tasks', 'Create task [title]', 'Update task [ID] to [status]', etc.</p><h3>File Upload</h3><p>Attach PDFs, images, or text files to tasks via the 'Attach Files' option.</p></div>
            </div>
        </div>
        <div id="edit-task-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header"><h2>Edit Task</h2><span class="modal-close" onclick="closeEditModal()">×</span></div>
                <form id="edit-task-form" onsubmit="saveTaskEdit(event)">
                    <input type="hidden" id="edit-task-id">
                    <div class="form-group"><label class="form-label" for="edit-task-title">Task Title*</label><input type="text" class="form-input" id="edit-task-title" required aria-required="true"></div>
                    <div class="form-group"><label class="form-label" for="edit-task-description">Description</label><textarea class="form-textarea" rows="4" id="edit-task-description"></textarea></div>
                    <div class="form-group"><label class="form-label" for="edit-task-assignee">Assign To*</label><select class="form-select" id="edit-task-assignee" required aria-required="true"></select></div>
                    <div class="form-group"><label class="form-label" for="edit-task-priority">Priority</label><select class="form-select" id="edit-task-priority"></select></div>
                    <div class="form-group"><label class="form-label" for="edit-task-due-date">Due Date</label><input type="date" class="form-input" id="edit-task-due-date"></div>
                    <div class="form-group"><label class="form-label" for="edit-task-department">Department</label><select class="form-select" id="edit-task-department"></select></div>
                    <div class="form-group"><label class="form-label" for="edit-task-dependencies">Dependencies</label><select class="form-select" id="edit-task-dependencies" multiple></select></div>
                    <div class="form-group"><label class="form-label" for="edit-task-files">Attach Files</label><input type="file" class="form-input" id="edit-task-files" multiple accept=".pdf,.txt,.jpg,.png"></div>
                    <div class="form-group"><label class="form-label"><input type="checkbox" id="edit-task-milestone"> Mark as Milestone</label></div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;"><button type="submit" class="btn btn-primary">Save Changes</button><button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button></div>
                </form>
                <div id="edit-task-files-preview" class="file-list"></div>
            </div>
        </div>
        <div id="notification" class="notification"></div>
        <div id="voice-input" style="position: fixed; bottom: 20px; right: 20px; display: none;"><button class="btn btn-primary" onclick="startVoiceInput()">🎙️ Voice Input</button></div>
    </div>
    <script>
        let currentUser = null;
        let tasks = [];
        let taskTrendsChart = null;
        let users = {
            floice_mukabana: { name: 'Floice Mukabana', role: 'Chief Executive Officer', avatar: 'FM', level: 0, department: 'Executive', canAssignTo: ['celestine_rono', 'victor_otieno', 'rebecca_mpaayei', 'reuben_wanjala', 'maureen_mambo', 'austin_macheso'] },
            celestine_rono: { name: 'Celestine Rono', role: 'Strategy Director', avatar: 'CR', level: 1, department: 'Strategy, Planning & Quality Assurance', manager: 'floice_mukabana', canAssignTo: ['rebecca_mpaayei', 'austin_macheso'] },
            victor_otieno: { name: 'Victor Otieno', role: 'Audit Director', avatar: 'VO', level: 1, department: 'Audit', manager: 'floice_mukabana', canAssignTo: ['mary_wanjiku'] },
            rebecca_mpaayei: { name: 'Rebecca Mpaayei', role: 'PMDD Manager', avatar: 'RM', level: 2, department: 'Product & Market Development', manager: 'celestine_rono', canAssignTo: ['austin_macheso', 'peter_ouma'] },
            reuben_wanjala: { name: 'Reuben Wanjala', role: 'Director Resource Center', avatar: 'RW', level: 1, department: 'Resource Center', manager: 'floice_mukabana', canAssignTo: ['wycliffe_rono'] },
            wycliffe_rono: { name: 'Wycliffe Rono', role: 'ICT Manager', avatar: 'WR', level: 2, department: 'ICT', manager: 'reuben_wanjala', canAssignTo: ['peter_ouma'] },
            maureen_mambo: { name: 'Maureen Mambo', role: 'Director Nation Brand Development', avatar: 'MM', level: 1, department: 'Nation Brand Development', manager: 'floice_mukabana', canAssignTo: ['mary_wanjiku'] },
            austin_macheso: { name: 'Austin Macheso', role: 'Product Development Expert', avatar: 'AM', level: 3, department: 'Product & Market Development', manager: 'rebecca_mpaayei', canAssignTo: ['peter_ouma'] },
            peter_ouma: { name: 'Peter Ouma', role: 'Senior Analyst', avatar: 'PO', level: 4, department: 'Product & Market Development', manager: 'austin_macheso', canAssignTo: ['mary_wanjiku'] },
            mary_wanjiku: { name: 'Mary Wanjiku', role: 'Analyst', avatar: 'MW', level: 5, department: 'Product & Market Development', manager: 'peter_ouma', canAssignTo: [] }
        };

        function initializeTasks() {
            tasks = [
                { id: 1, title: 'Q4 Export Strategy Development', description: 'Develop export strategy for Q4.', creator: 'floice_mukabana', assignee: 'celestine_rono', status: 'in-progress', priority: 'High', dueDate: '2025-12-15', department: 'Strategy, Planning & Quality Assurance', createdAt: new Date('2025-07-01'), comments: [], dependencies: [], isMilestone: true, files: [] },
                { id: 2, title: 'Financial Audit Preparation', description: 'Prepare for annual audit.', creator: 'floice_mukabana', assignee: 'victor_otieno', status: 'done', priority: 'Critical', dueDate: '2025-07-28', department: 'Audit', createdAt: new Date('2025-07-15'), comments: [], dependencies: [], isMilestone: false, files: [] },
                { id: 3, title: 'Product Market Analysis', description: 'Analyze market for Made in Kenya products.', creator: 'celestine_rono', assignee: 'rebecca_mpaayei', status: 'not-started', priority: 'Medium', dueDate: '2025-09-10', department: 'Product & Market Development', createdAt: new Date('2025-07-20'), comments: [], dependencies: [1], isMilestone: false, files: [] },
                { id: 4, title: 'ICT System Upgrade', description: 'Upgrade task system infrastructure.', creator: 'reuben_wanjala', assignee: 'wycliffe_rono', status: 'in-progress', priority: 'High', dueDate: '2025-08-05', department: 'ICT', createdAt: new Date('2025-07-18'), comments: [], dependencies: [], isMilestone: true, files: [] }
            ];
        }

        function saveTasks() { localStorage.setItem('keproba_tasks', JSON.stringify(tasks)); }
        function loadTasks() { const saved = localStorage.getItem('keproba_tasks'); if (saved) tasks = JSON.parse(saved).map(t => ({ ...t, createdAt: new Date(t.createdAt), comments: t.comments.map(c => ({ ...c, timestamp: new Date(c.timestamp) })), dependencies: t.dependencies || [], isMilestone: t.isMilestone || false, files: t.files || [] })); else initializeTasks(); }

        function checkReminders() {
            tasks.forEach(task => {
                const dueDate = new Date(task.dueDate);
                const now = new Date();
                const oneDayBefore = new Date(dueDate.getTime() - 24 * 60 * 60 * 1000);
                if (now >= oneDayBefore && now < dueDate && task.status !== 'done' && task.assignee === currentUser) {
                    showNotification(`Reminder: '${task.title}' is due tomorrow!`, 'warning');
                    speak(`Reminder: ${task.title} is due tomorrow.`);
                }
            });
        }

        function updateUserInterface() {
            if (!currentUser) return;
            const user = users[currentUser];
            document.getElementById('current-user-name').textContent = user.name;
            document.getElementById('current-user-role').textContent = user.role;
            document.getElementById('current-user-avatar').textContent = user.avatar;
            updateAssigneeOptions();
            updateDependencyOptions();
            updateDashboard();
            updateTasksView();
            updateAssignedTasksView();
            updateHierarchyView();
            updatePerformanceView();
            document.getElementById('voice-input').style.display = 'block';
        }

        function initializeLogin() {
            const userSelect = document.getElementById('login-user');
            userSelect.innerHTML = Object.keys(users).map(id => `<option value="${id}">${users[id].name} (${users[id].role})</option>`).join('');
            document.querySelectorAll('.page:not(#login)').forEach(page => page.classList.remove('active'));
            document.getElementById('login').classList.add('active');
        }

        function handleLogin(event) {
            event.preventDefault();
            currentUser = document.getElementById('login-user').value;
            document.getElementById('login').classList.remove('active');
            document.getElementById('dashboard').classList.add('active');
            updateUserInterface();
            showNotification(`Welcome, ${users[currentUser].name}!`, 'success');
            speak(`Welcome, ${users[currentUser].name}. You are now logged in.`);
        }

        function switchUser() {
            document.getElementById('login').classList.add('active');
            document.querySelectorAll('.page:not(#login)').forEach(page => page.classList.remove('active'));
            currentUser = null;
            updateUserInterface();
        }

        function updateAssigneeOptions() {
            const assigneeSelect = document.getElementById('task-assignee');
            const editAssigneeSelect = document.getElementById('edit-task-assignee');
            const user = users[currentUser];
            [assigneeSelect, editAssigneeSelect].forEach(select => {
                select.innerHTML = '<option value="">Select assignee...</option>';
                if (user.canAssignTo) user.canAssignTo.forEach(userId => {
                    const assignee = users[userId];
                    select.innerHTML += `<option value="${userId}">${assignee.name} - ${assignee.role} (${assignee.department})</option>`;
                });
            });
        }

        function updateDependencyOptions() {
            const depSelect = document.getElementById('task-dependencies');
            const editDepSelect = document.getElementById('edit-task-dependencies');
            [depSelect, editDepSelect].forEach(select => {
                select.innerHTML = tasks.filter(t => t.creator === currentUser && t.id !== parseInt(select.dataset.taskId || '0')).map(t => `<option value="${t.id}">${t.title}</option>`).join('');
            });
        }

        function updateDashboard() {
            const filter = document.getElementById('dashboard-filter').value || 'all';
            let myTasks = tasks.filter(t => t.creator === currentUser);
            let assignedToMe = tasks.filter(t => t.assignee === currentUser);
            let allTasks = [...myTasks, ...assignedToMe];

            const now = new Date();
            if (filter === 'week') allTasks = allTasks.filter(t => new Date(t.createdAt) >= new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000));
            else if (filter === 'month') allTasks = allTasks.filter(t => new Date(t.createdAt) >= new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000));

            const stats = { total: allTasks.length, completed: allTasks.filter(t => t.status === 'done').length, inProgress: allTasks.filter(t => t.status === 'in-progress').length, overdue: allTasks.filter(t => new Date(t.dueDate) < now && t.status !== 'done').length };
            document.getElementById('dashboard-stats').innerHTML = `
                <div class="stat-item"><div class="stat-number">${stats.total}</div><div class="stat-label">Total Tasks</div></div>
                <div class="stat-item"><div class="stat-number">${stats.completed}</div><div class="stat-label">Completed</div></div>
                <div class="stat-item"><div class="stat-number">${stats.inProgress}</div><div class="stat-label">In Progress</div></div>
                <div class="stat-item"><div class="stat-number">${stats.overdue}</div><div class="stat-label">Overdue</div></div>
            `;
            document.getElementById('recent-activities').innerHTML = allTasks.slice(0, 3).map(t => createTaskHTML(t, true)).join('');
        }

        function getMyTasks() {
            let myTasks = tasks.filter(t => t.creator === currentUser);
            applyFilters(myTasks, 'tasks');
            return myTasks.sort((a, b) => {
                const sortBy = document.getElementById('sort-by').value || 'dueDate-asc';
                if (sortBy === 'dueDate-asc') return new Date(a.dueDate || '9999-12-31') - new Date(b.dueDate || '9999-12-31');
                if (sortBy === 'dueDate-desc') return new Date(b.dueDate || '9999-12-31') - new Date(a.dueDate || '9999-12-31');
                if (sortBy === 'priority') return ['Critical', 'High', 'Medium', 'Low'].indexOf(b.priority) - ['Critical', 'High', 'Medium', 'Low'].indexOf(a.priority);
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
        }

        function getAssignedToMe() {
            let assignedTasks = tasks.filter(t => t.assignee === currentUser);
            applyFilters(assignedTasks, 'assigned');
            return assignedTasks;
        }

        function applyFilters(tasks, type) {
            const filters = {
                status: document.getElementById(`${type}-filter`)?.value || 'all',
                dept: document.getElementById(`${type}-department-filter`)?.value || 'all',
                priority: document.getElementById(`${type}-priority-filter`)?.value || 'all',
                search: document.getElementById(`${type}-task-search`)?.value.toLowerCase() || ''
            };
            if (filters.status !== 'all') tasks = tasks.filter(t => t.status === filters.status);
            if (filters.dept !== 'all') tasks = tasks.filter(t => t.department === filters.dept);
            if (filters.priority !== 'all') tasks = tasks.filter(t => t.priority === filters.priority);
            if (filters.search) tasks = tasks.filter(t => t.title.toLowerCase().includes(filters.search) || t.description?.toLowerCase().includes(filters.search));
        }

        function createTaskHTML(task, isPreview = false) {
            const progress = { 'done': 100, 'completed': 80, 'in-progress': 50, 'not-started': 0 };
            return `
                <div class="task-item" data-task-id="${task.id}">
                    <div class="task-header"><div class="task-title">${task.title}${task.isMilestone ? ' ⭐' : ''}</div><div class="task-status status-${task.status}" onclick="cycleTaskStatus(${task.id})">${task.status.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}</div></div>
                    <div class="task-meta"><span>👤 ${task.creator === currentUser ? 'To: ' + users[task.assignee].name : 'From: ' + users[task.creator].name}</span><span>📅 Due: ${task.dueDate || 'No due date'}</span><span>⏰ ${task.priority}</span><span>🏢 ${task.department || 'None'}</span></div>
                    ${task.description ? `<div>${task.description}</div>` : ''}<div class="progress-bar"><div class="progress-fill" style="width: ${progress[task.status]}%;"></div></div>
                    ${task.files.length ? `<div class="file-list">${task.files.map(f => `<div class="file-item"><a href="${f.url}" target="_blank">${f.name}</a> (${f.size} KB)</div>`).join('')}</div>` : ''}
                    ${!isPreview ? `<div class="task-actions">${(task.assignee === currentUser || task.creator === currentUser) ? `<button class="btn btn-primary" onclick="updateTaskStatus(${task.id}, '${getNextStatus(task.status)}')">Next: ${getNextStatusText(task.status)}</button>` : ''}${task.creator === currentUser ? `<button class="btn btn-secondary" onclick="editTask(${task.id})">Edit</button>` : ''}<button class="btn btn-secondary" onclick="toggleComments(${task.id})">Comments (${task.comments.length})</button>${task.creator === currentUser ? `<button class="btn btn-warning" onclick="deleteTask(${task.id})">Delete</button>` : ''}</div><div id="comments-${task.id}" class="task-comments" style="display: none;">${task.comments.map(c => `<div class="comment"><div class="comment-author">${users[c.author].name}</div><div>${c.text}</div><div>${new Date(c.timestamp).toLocaleString()}</div></div>`).join('')}<div class="add-comment"><input class="comment-input" placeholder="Add comment..." onkeypress="if(event.key==='Enter')addComment(${task.id})"><button class="btn btn-primary" onclick="addComment(${task.id})">Add</button></div></div>` : ''}
                </div>
            `;
        }

        function updateTasksView() { document.getElementById('my-tasks-list').innerHTML = getMyTasks().length ? getMyTasks().map(t => createTaskHTML(t)).join('') : '<div style="text-align:center;padding:40px;color:var(--primary-black);">No tasks yet.</div>'; }
        function updateAssignedTasksView() {
            const tasks = getAssignedToMe();
            document.getElementById('assigned-tasks-notice').innerHTML = tasks.filter(t => t.status !== 'done').length ? `<div class="task-assignment"><div class="assignment-alert">⚠️ ${tasks.filter(t => t.status !== 'done').length} pending task(s)!</div></div>` : '';
            document.getElementById('assigned-tasks-list').innerHTML = tasks.length ? tasks.map(t => createTaskHTML(t)).join('') : '<div style="text-align:center;padding:40px;color:var(--primary-black);">No assigned tasks.</div>';
        }

        function updateHierarchyView() {
            const hierarchy = `
                <div class="hierarchy-level"><div class="hierarchy-item"><strong>${users.floice_mukabana.name}</strong><span class="role-indicator">CEO</span><div>${getTaskCount('floice_mukabana', 'creator')} created, ${getTaskCount('floice_mukabana', 'assignee')} assigned, ${getCompletedCount('floice_mukabana')} completed</div></div></div>
                <div class="hierarchy-level level-1"><div class="hierarchy-item"><strong>${users.celestine_rono.name}</strong><span class="role-indicator">Strategy Director</span><div>${getTaskCount('celestine_rono', 'creator')} created, ${getTaskCount('celestine_rono', 'assignee')} assigned, ${getCompletedCount('celestine_rono')} completed</div></div><div class="hierarchy-item"><strong>${users.victor_otieno.name}</strong><span class="role-indicator">Audit Director</span><div>${getTaskCount('victor_otieno', 'creator')} created, ${getTaskCount('victor_otieno', 'assignee')} assigned, ${getCompletedCount('victor_otieno')} completed</div></div><div class="hierarchy-item"><strong>${users.reuben_wanjala.name}</strong><span class="role-indicator">Director Resource Center</span><div>${getTaskCount('reuben_wanjala', 'creator')} created, ${getTaskCount('reuben_wanjala', 'assignee')} assigned, ${getCompletedCount('reuben_wanjala')} completed</div></div><div class="hierarchy-item"><strong>${users.maureen_mambo.name}</strong><span class="role-indicator">Director Nation Brand Development</span><div>${getTaskCount('maureen_mambo', 'creator')} created, ${getTaskCount('maureen_mambo', 'assignee')} assigned, ${getCompletedCount('maureen_mambo')} completed</div></div></div>
                <div class="hierarchy-level level-2"><div class="hierarchy-item"><strong>${users.rebecca_mpaayei.name}</strong><span class="role-indicator">PMDD Manager</span><div>${getTaskCount('rebecca_mpaayei', 'creator')} created, ${getTaskCount('rebecca_mpaayei', 'assignee')} assigned, ${getCompletedCount('rebecca_mpaayei')} completed</div></div><div class="hierarchy-item"><strong>${users.wycliffe_rono.name}</strong><span class="role-indicator">ICT Manager</span><div>${getTaskCount('wycliffe_rono', 'creator')} created, ${getTaskCount('wycliffe_rono', 'assignee')} assigned, ${getCompletedCount('wycliffe_rono')} completed</div></div></div>
                <div class="hierarchy-level level-3"><div class="hierarchy-item"><strong>${users.austin_macheso.name}</strong><span class="role-indicator">Product Development Expert</span><div>${getTaskCount('austin_macheso', 'creator')} created, ${getTaskCount('austin_macheso', 'assignee')} assigned, ${getCompletedCount('austin_macheso')} completed</div></div></div>
                <div class="hierarchy-level level-4"><div class="hierarchy-item"><strong>${users.peter_ouma.name}</strong><span class="role-indicator">Senior Analyst</span><div>${getTaskCount('peter_ouma', 'creator')} created, ${getTaskCount('peter_ouma', 'assignee')} assigned, ${getCompletedCount('peter_ouma')} completed</div></div></div>
                <div class="hierarchy-level level-5"><div class="hierarchy-item"><strong>${users.mary_wanjiku.name}</strong><span class="role-indicator">Analyst</span><div>${getTaskCount('mary_wanjiku', 'creator')} created, ${getTaskCount('mary_wanjiku', 'assignee')} assigned, ${getCompletedCount('mary_wanjiku')} completed</div></div></div>
            `;
            document.getElementById('hierarchy-content').innerHTML = hierarchy;
        }

        function updatePerformanceView() {
            if (users[currentUser].level > 1) { showNotification('Access restricted: Managerial role required', 'error'); showPage('dashboard'); return; }
            const userFilter = document.getElementById('performance-user-filter').value || 'all';
            const timeFilter = document.getElementById('performance-time-filter').value || 'all';
            let filteredTasks = tasks;
            if (userFilter !== 'all') filteredTasks = filteredTasks.filter(t => t.assignee === userFilter || t.creator === userFilter);
            const now = new Date();
            if (timeFilter === 'week') filteredTasks = filteredTasks.filter(t => new Date(t.createdAt) >= new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000));
            else if (timeFilter === 'month') filteredTasks = filteredTasks.filter(t => new Date(t.createdAt) >= new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000));
            const stats = { total: filteredTasks.length, completed: filteredTasks.filter(t => t.status === 'done').length, overdue: filteredTasks.filter(t => new Date(t.dueDate) < now && t.status !== 'done').length, rate: filteredTasks.length ? (filteredTasks.filter(t => t.status === 'done').length / filteredTasks.length * 100).toFixed(1) : 0 };
            document.getElementById('performance-stats').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item"><div class="stat-number">${stats.total}</div><div class="stat-label">Total Tasks</div></div>
                    <div class="stat-item"><div class="stat-number">${stats.completed}</div><div class="stat-label">Completed</div></div>
                    <div class="stat-item"><div class="stat-number">${stats.overdue}</div><div class="stat-label">Overdue</div></div>
                    <div class="stat-item"><div class="stat-number">${stats.rate}%</div><div class="stat-label">Completion Rate</div></div>
                </div>
            `;
            document.getElementById('performance-user-filter').innerHTML = '<option value="all">All Users</option>' + Object.keys(users).map(id => `<option value="${id}">${users[id].name}</option>`).join('');
            document.getElementById('performance-time-filter').innerHTML = '<option value="all">All Time</option><option value="week">This Week</option><option value="month">This Month</option>';
            if (taskTrendsChart) taskTrendsChart.destroy();
            const ctx = document.getElementById('task-trends-chart').getContext('2d');
            taskTrendsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Executive', 'Strategy', 'Audit', 'PMD', 'Resource', 'ICT', 'Nation'],
                    datasets: [{
                        label: 'Tasks',
                        data: ['Executive', 'Strategy, Planning & Quality Assurance', 'Audit', 'Product & Market Development', 'Resource Center', 'ICT', 'Nation Brand Development'].map(d => filteredTasks.filter(t => t.department === d).length),
                        backgroundColor: (context) => {
                            const chart = context.chart;
                            const { ctx, chartArea } = chart;
                            if (!chartArea) return;
                            const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                            gradient.addColorStop(0, ['var(--primary-green)', 'var(--accent-blue)', 'var(--primary-red)', '#fdcb6e', '#55a3ff', '#00b894', '#e84393'][context.dataIndex]);
                            gradient.addColorStop(1, 'rgba(255, 255, 255, 0.3)');
                            return gradient;
                        },
                        borderColor: ['var(--primary-green)', 'var(--accent-blue)', 'var(--primary-red)', '#fdcb6e', '#55a3ff', '#00b894', '#e84393'],
                        borderWidth: 2,
                        borderRadius: 5,
                        barThickness: 30,
                        hoverBackgroundColor: 'rgba(255, 255, 255, 0.7)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 1000, easing: 'easeInOutQuad' },
                    plugins: {
                        legend: { position: 'top', labels: { color: 'var(--primary-black)', font: { size: 14 } } },
                        datalabels: { color: 'var(--primary-white)', font: { weight: 'bold' }, anchor: 'end', align: 'top', formatter: (value) => value > 0 ? value : '' }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Number of Tasks', color: 'var(--primary-black)' }, ticks: { color: 'var(--primary-black)' } },
                        x: { title: { display: true, text: 'Departments', color: 'var(--primary-black)' }, ticks: { color: 'var(--primary-black)' } }
                    },
                    onHover: (event, chartElement) => { event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default'; }
                }
            });
        }

        function getTaskCount(userId, role) { return tasks.filter(t => t[role] === userId).length; }
        function getCompletedCount(userId) { return tasks.filter(t => (t.creator === userId || t.assignee === userId) && t.status === 'done').length; }
        function formatDate(date) { return date ? new Date(date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'No due date'; }
        const statusFlow = { 'not-started': 'in-progress', 'in-progress': 'completed', 'completed': 'done', 'done': 'in-progress' };
        function getNextStatus(status) { return statusFlow[status] || 'in-progress'; }
        const statusTexts = { 'not-started': 'Start', 'in-progress': 'Complete', 'completed': 'Done', 'done': 'Reopen' };
        function getNextStatusText(status) { return statusTexts[status] || 'Update'; }

        function createTask(event) {
            event.preventDefault();
            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const assignee = document.getElementById('task-assignee').value;
            const priority = document.getElementById('task-priority').value || 'Medium';
            const dueDate = document.getElementById('task-due-date').value;
            const department = document.getElementById('task-department').value;
            const dependencies = Array.from(document.getElementById('task-dependencies').selectedOptions).map(o => parseInt(o.value));
            const isMilestone = document.getElementById('task-milestone').checked;
            const files = document.getElementById('task-files').files;
            if (!title || !assignee) { showNotification('Missing title or assignee!', 'error'); return; }
            const newTask = { id: Date.now(), title, description, creator: currentUser, assignee, status: 'not-started', priority, dueDate, department, createdAt: new Date(), comments: [], dependencies, isMilestone, files: [] };
            if (files.length) {
                Array.from(files).forEach(file => {
                    const url = URL.createObjectURL(file);
                    newTask.files.push({ name: file.name, size: (file.size / 1024).toFixed(1), url, type: file.type });
                });
            }
            tasks.push(newTask); saveTasks();
            document.getElementById('task-form').reset();
            showNotification(`Task '${title}' created for ${users[assignee].name}!`, 'success');
            speak(`Task ${title} created for ${users[assignee].name}.`);
            updateUserInterface();
        }

        function updateTaskStatus(taskId, newStatus) {
            const task = tasks.find(t => t.id === taskId);
            if (task && (task.assignee === currentUser || task.creator === currentUser)) {
                task.status = newStatus;
                task.comments.push({ author: currentUser, text: `Status updated to ${newStatus}`, timestamp: new Date() });
                saveTasks();
                showNotification(`Task '${task.title}' status updated to ${newStatus}!`, 'success');
                speak(`Task ${task.title} status updated to ${newStatus}.`);
                updateUserInterface();
            }
        }

        function cycleTaskStatus(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task && (task.assignee === currentUser || task.creator === currentUser)) {
                if (task.status === 'not-started' && task.dependencies.length) {
                    const incomplete = task.dependencies.some(id => !tasks.find(t => t.id === id)?.status === 'done');
                    if (incomplete) { showNotification('Complete dependencies first!', 'error'); return; }
                }
                updateTaskStatus(taskId, getNextStatus(task.status));
            }
        }

        function addComment(taskId) {
            const task = tasks.find(t => t.id === taskId);
            const input = document.querySelector(`#comments-${taskId} .comment-input`);
            const text = input.value.trim();
            if (task && text) {
                task.comments.push({ author: currentUser, text, timestamp: new Date() });
                saveTasks(); input.value = '';
                showNotification('Comment added!', 'success');
                speak('Comment added.');
                updateUserInterface();
            }
        }

        function toggleComments(taskId) { document.getElementById(`comments-${taskId}`).style.display = document.getElementById(`comments-${taskId}`).style.display === 'none' ? 'block' : 'none'; }

        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task && task.creator === currentUser) {
                document.getElementById('edit-task-id').value = task.id;
                document.getElementById('edit-task-title').value = task.title;
                document.getElementById('edit-task-description').value = task.description || '';
                document.getElementById('edit-task-assignee').value = task.assignee;
                document.getElementById('edit-task-priority').value = task.priority;
                document.getElementById('edit-task-due-date').value = task.dueDate || '';
                document.getElementById('edit-task-department').value = task.department || '';
                document.getElementById('edit-task-milestone').checked = task.isMilestone;
                const depSelect = document.getElementById('edit-task-dependencies');
                depSelect.dataset.taskId = task.id; updateDependencyOptions();
                Array.from(depSelect.options).forEach(o => o.selected = task.dependencies.includes(parseInt(o.value)));
                document.getElementById('edit-task-files').value = '';
                document.getElementById('edit-task-files-preview').innerHTML = task.files.map(f => `<div class="file-item"><a href="${f.url}" target="_blank">${f.name}</a> (${f.size} KB)</div>`).join('');
                document.getElementById('edit-task-modal').style.display = 'flex';
            }
        }

        function saveTaskEdit(event) {
            event.preventDefault();
            const taskId = parseInt(document.getElementById('edit-task-id').value);
            const task = tasks.find(t => t.id === taskId);
            if (task && task.creator === currentUser) {
                task.title = document.getElementById('edit-task-title').value;
                task.description = document.getElementById('edit-task-description').value;
                task.assignee = document.getElementById('edit-task-assignee').value;
                task.priority = document.getElementById('edit-task-priority').value;
                task.dueDate = document.getElementById('edit-task-due-date').value;
                task.department = document.getElementById('edit-task-department').value;
                task.dependencies = Array.from(document.getElementById('edit-task-dependencies').selectedOptions).map(o => parseInt(o.value));
                task.isMilestone = document.getElementById('edit-task-milestone').checked;
                const files = document.getElementById('edit-task-files').files;
                if (files.length) {
                    Array.from(files).forEach(file => {
                        const url = URL.createObjectURL(file);
                        task.files.push({ name: file.name, size: (file.size / 1024).toFixed(1), url, type: file.type });
                    });
                }
                saveTasks(); closeEditModal();
                showNotification('Task updated!', 'success');
                speak('Task updated.');
                updateUserInterface();
            }
        }

        function closeEditModal() { document.getElementById('edit-task-modal').style.display = 'none'; document.getElementById('edit-task-form').reset(); document.getElementById('edit-task-files-preview').innerHTML = ''; }

        function deleteTask(taskId) {
            if (confirm('Delete task?')) {
                tasks = tasks.filter(t => t.id !== taskId);
                saveTasks();
                showNotification('Task deleted!', 'success');
                speak('Task deleted.');
                updateUserInterface();
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show', type);
            setTimeout(() => notification.classList.remove('show', type), 3000);
        }

        function speak(text) { responsiveVoice.speak(text, "UK English Female", { rate: 0.9 }); }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[onclick="showPage('${pageId}')"]`).classList.add('active');
            if (pageId === 'dashboard') updateDashboard();
            else if (pageId === 'tasks') updateTasksView();
            else if (pageId === 'assigned') updateAssignedTasksView();
            else if (pageId === 'hierarchy') updateHierarchyView();
            else if (pageId === 'performance') updatePerformanceView();
            speak(`Showing ${pageId} page.`);
        }

        function toggleHighContrast() { document.body.toggleAttribute('high-contrast'); showNotification('High contrast toggled.', 'success'); speak('High contrast toggled.'); }

        function startVoiceInput() {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            recognition.start();
            recognition.onresult = (event) => {
                const command = event.results[0][0].transcript.toLowerCase().trim();
                processVoiceCommand(command);
            };
            recognition.onerror = () => showNotification('Voice recognition failed.', 'error');
            showNotification('Listening for voice command...', 'info');
            speak('Please say your command.');
        }

        function processVoiceCommand(command) {
            const [action, ...params] = command.split(' ');
            const paramStr = params.join(' ');
            if (action === 'show' && params[0] === 'tasks') updateTasksView();
            else if (action === 'show' && params[0] === 'assigned') updateAssignedTasksView();
            else if (action === 'create' && params[0] === 'task') {
                const [title, assigned, due] = paramStr.match(/task\s+(.+?)\s+assigned\s+to\s+(.+?)\s+due\s+(.+)/i)?.slice(1) || [];
                if (title && assigned && due) createTaskFromVoice(title, assigned, due);
            } else if (action === 'update' && params[0] === 'task') {
                const [id, to] = paramStr.match(/task\s+(\d+)\s+to\s+(.+)/i)?.slice(1) || [];
                if (id && to) updateTaskStatus(parseInt(id), to);
            } else if (action === 'switch' && params[0] === 'user') {
                const user = Object.keys(users).find(u => users[u].name.toLowerCase() === paramStr);
                if (user) switchToUser(user);
            } else if (action === 'help') showPage('help');
            else showNotification('Command not recognized. Say "Help" for options.', 'error');
        }

        function createTaskFromVoice(title, assignedName, dueDate) {
            const assignee = Object.keys(users).find(u => users[u].name.toLowerCase() === assignedName.toLowerCase());
            if (assignee && users[currentUser].canAssignTo.includes(assignee)) {
                const newTask = { id: Date.now(), title, creator: currentUser, assignee, status: 'not-started', priority: 'Medium', dueDate, department: users[assignee].department, createdAt: new Date(), comments: [], dependencies: [], isMilestone: false, files: [] };
                tasks.push(newTask); saveTasks();
                showNotification(`Task '${title}' created for ${users[assignee].name}!`, 'success');
                speak(`Task ${title} created for ${users[assignee].name}.`);
                updateUserInterface();
            } else showNotification('Invalid assignee or permission denied.', 'error');
        }

        function switchToUser(userId) {
            currentUser = userId;
            document.getElementById('login').classList.remove('active');
            document.getElementById('dashboard').classList.add('active');
            updateUserInterface();
            showNotification(`Switched to ${users[userId].name}!`, 'success');
            speak(`Switched to ${users[userId].name}.`);
        }

        // Initialize
        loadTasks();
        initializeLogin();
        document.getElementById('dashboard-filter').innerHTML = '<option value="all">All Time</option><option value="week">This Week</option><option value="month">This Month</option>';
        document.getElementById('tasks-filter').innerHTML = '<option value="all">All Tasks</option><option value="active">Active</option><option value="completed">Completed</option>';
        document.getElementById('department-filter').innerHTML = '<option value="all">All Departments</option><option value="Executive">Executive</option><option value="Strategy, Planning & Quality Assurance">Strategy, Planning & QA</option><option value="Audit">Audit</option><option value="Product & Market Development">Product & Market Development</option><option value="Resource Center">Resource Center</option><option value="ICT">ICT</option><option value="Nation Brand Development">Nation Brand Development</option>';
        document.getElementById('priority-filter').innerHTML = '<option value="all">All Priorities</option><option value="Low">Low</option><option value="Medium">Medium</option><option value="High">High</option><option value="Critical">Critical</option>';
        document.getElementById('sort-by').innerHTML = '<option value="dueDate-asc">Due Date (Asc)</option><option value="dueDate-desc">Due Date (Desc)</option><option value="priority">Priority</option><option value="createdAt">Creation Date</option>';
        document.getElementById('task-priority').innerHTML = '<option value="Low">Low</option><option value="Medium">Medium</option><option value="High">High</option><option value="Critical">Critical</option>';
        document.getElementById('task-department').innerHTML = '<option value="">Select department...</option><option value="Executive">Executive</option><option value="Strategy, Planning & Quality Assurance">Strategy, Planning & QA</option><option value="Audit">Audit</option><option value="Product & Market Development">Product & Market Development</option><option value="Resource Center">Resource Center</option><option value="ICT">ICT</option><option value="Nation Brand Development">Nation Brand Development</option>';
        setInterval(checkReminders, 60000); // Check reminders every minute
    </script>
</body>
</html>