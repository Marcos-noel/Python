<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEPROBA Task Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-green: #006400; /* Kenya green */
            --primary-red: #B22222; /* Kenya red */
            --primary-black: #1C2526; /* Kenya black */
            --primary-white: #F5F6F5; /* Kenya white */
            --accent-blue: #4682B4; /* Modern branding blue */
            --high-contrast-text: #1a1a1a;
            --high-contrast-bg: #ffffff;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-green), var(--accent-blue));
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo img {
            max-height: 60px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-switcher {
            padding: 8px 16px;
            background: linear-gradient(45deg, var(--primary-green), var(--accent-blue));
            color: var(--primary-white);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .user-avatar {
            width: 45px;
            height: 45px;
            background: linear-gradient(45deg, var(--primary-green), var(--accent-blue));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-white);
            font-weight: bold;
            font-size: 18px;
        }
        
        .navigation {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            padding: 12px 24px;
            background: transparent;
            border: 2px solid #ddd;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--primary-black);
        }
        
        .nav-tab.active {
            background: linear-gradient(45deg, var(--primary-green), var(--accent-blue));
            color: var(--primary-white);
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 100, 0, 0.3);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .card-title {
            font-size: 22px;
            font-weight: bold;
            color: var(--primary-black);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-green), var(--accent-blue));
            border-radius: 15px;
            color: var(--primary-white);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .task-item {
            padding: 20px;
            border-left: 4px solid var(--primary-green);
            background: var(--primary-white);
            border-radius: 10px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .task-item:hover {
            background: #e9ecef;
            border-left-color: var(--accent-blue);
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .task-title {
            font-weight: 600;
            color: var(--primary-black);
            font-size: 16px;
        }
        
        .task-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .task-status {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .status-not-started {
            background: var(--primary-red);
            color: var(--primary-white);
        }
        
        .status-in-progress {
            background: #fdcb6e;
            color: #e17055;
        }
        
        .status-completed {
            background: var(--accent-blue);
            color: var(--primary-white);
        }
        
        .status-done {
            background: var(--primary-green);
            color: var(--primary-white);
        }
        
        .task-meta {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: var(--primary-black);
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, var(--primary-green), var(--accent-blue));
            color: var(--primary-white);
        }
        
        .btn-secondary {
            background: #e9ecef;
            color: var(--primary-black);
        }
        
        .btn-success {
            background: var(--primary-green);
            color: var(--primary-white);
        }
        
        .btn-warning {
            background: #fdcb6e;
            color: #e17055;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-black);
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-green);
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, var(--primary-green), var(--accent-blue));
            transition: width 0.3s ease;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: var(--primary-green);
            color: var(--primary-white);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: var(--primary-red);
        }
        
        .notification.warning {
            background: #fdcb6e;
            color: #e17055;
        }
        
        .task-comments {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        
        .comment {
            background: var(--primary-white);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .comment-author {
            font-weight: 600;
            color: var(--primary-green);
            margin-bottom: 5px;
        }
        
        .add-comment {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .comment-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .task-assignment {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .assignment-alert {
            color: #856404;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .filter-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: var(--primary-white);
            padding: 20px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-close {
            cursor: pointer;
            font-size: 20px;
        }
        
        .hierarchy-view {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .hierarchy-level {
            margin-left: 0;
            margin-bottom: 20px;
        }
        
        .hierarchy-level.level-1 { margin-left: 20px; }
        .hierarchy-level.level-2 { margin-left: 40px; }
        .hierarchy-level.level-3 { margin-left: 60px; }
        .hierarchy-level.level-4 { margin-left: 80px; }
        .hierarchy-level.level-5 { margin-left: 100px; }
        
        .hierarchy-item {
            background: var(--primary-white);
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 4px solid var(--primary-green);
            margin-bottom: 10px;
            position: relative;
        }
        
        .hierarchy-item::before {
            content: "";
            position: absolute;
            left: -25px;
            top: 50%;
            width: 20px;
            height: 2px;
            background: #ddd;
        }
        
        .role-indicator {
            display: inline-block;
            padding: 3px 8px;
            background: var(--primary-green);
            color: var(--primary-white);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 10px;
        }
        
        [data-tooltip] {
            position: relative;
        }
        
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-black);
            color: var(--primary-white);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
        }
        
        [high-contrast] .dashboard-card,
        [high-contrast] .hierarchy-item {
            background: var(--high-contrast-bg);
            color: var(--high-contrast-text);
            border: 2px solid var(--high-contrast-text);
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .task-actions {
                flex-direction: column;
                gap: 5px;
            }
        }
        
        @media (max-width: 480px) {
            .container { padding: 10px; }
            .form-input, .form-select, .form-textarea { font-size: 16px; }
            .btn { padding: 10px 20px; font-size: 14px; }
            .task-meta { flex-direction: column; gap: 5px; }
            .filter-group { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <img src="https://via.placeholder.com/150x60?text=KEPROBA+Logo" alt="KEPROBA Logo" aria-label="KEPROBA Logo">
            </div>
            <div class="user-info">
                <button class="user-switcher" onclick="switchUser()" data-tooltip="Switch to another user">Switch User</button>
                <div>
                    <div style="font-weight: 600;" id="current-user-name">Floice Mukabana</div>
                    <div style="font-size: 14px; color: var(--primary-black);" id="current-user-role">Chief Executive Officer</div>
                </div>
                <div class="user-avatar" id="current-user-avatar">FM</div>
            </div>
        </header>
        
        <nav class="navigation">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showPage('dashboard')" role="tab" aria-selected="true" aria-controls="dashboard" data-tooltip="View your task overview">📊 Dashboard</button>
                <button class="nav-tab" onclick="showPage('tasks')" role="tab" aria-selected="false" aria-controls="tasks" data-tooltip="View tasks you created">✅ My Tasks</button>
                <button class="nav-tab" onclick="showPage('create')" role="tab" aria-selected="false" aria-controls="create" data-tooltip="Create a new task">➕ Create Task</button>
                <button class="nav-tab" onclick="showPage('assigned')" role="tab" aria-selected="false" aria-controls="assigned" data-tooltip="View tasks assigned to you">📋 Assigned to Me</button>
                <button class="nav-tab" onclick="showPage('hierarchy')" role="tab" aria-selected="false" aria-controls="hierarchy" data-tooltip="View organizational hierarchy">🏢 Organization</button>
                <button class="nav-tab" onclick="showPage('performance')" role="tab" aria-selected="false" aria-controls="performance" data-tooltip="View performance metrics">📈 Performance</button>
                <button class="nav-tab" onclick="showPage('help')" role="tab" aria-selected="false" aria-controls="help" data-tooltip="View tutorials and FAQs">❓ Help</button>
                <button class="btn btn-secondary" onclick="toggleHighContrast()" data-tooltip="Toggle high contrast mode">Toggle High Contrast</button>
            </div>
        </nav>
        
        <!-- Login Page -->
        <div id="login" class="page active">
            <div class="dashboard-card full-width">
                <h2 class="card-title">🔒 Login</h2>
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label class="form-label" for="login-user">User</label>
                        <select class="form-select" id="login-user" required aria-required="true">
                            <!-- Dynamic user options -->
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Login</button>
                </form>
            </div>
        </div>
        
        <!-- Dashboard Page -->
        <div id="dashboard" class="page">
            <div class="main-content">
                <div class="dashboard-card">
                    <h2 class="card-title">📈 My Overview</h2>
                    <div class="filter-group">
                        <select class="form-select" id="dashboard-filter" onchange="updateDashboard()">
                            <option value="all">All Time</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                    <div class="stats-grid" id="dashboard-stats">
                        <!-- Dynamic stats -->
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <h2 class="card-title">🎯 Recent Activities</h2>
                    <div id="recent-activities">
                        <!-- Dynamic activities -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tasks Page -->
        <div id="tasks" class="page">
            <div class="dashboard-card full-width">
                <h2 class="card-title">✅ My Tasks & Delegated Items</h2>
                <div class="filter-group">
                    <input type="text" class="form-input" id="task-search" placeholder="Search tasks..." oninput="updateTasksView()">
                    <select class="form-select" id="tasks-filter" onchange="updateTasksView()">
                        <option value="all">All Tasks</option>
                        <option value="active">Active Tasks</option>
                        <option value="completed">Completed Tasks</option>
                    </select>
                    <select class="form-select" id="department-filter" onchange="updateTasksView()">
                        <option value="all">All Departments</option>
                        <option value="Executive">Executive</option>
                        <option value="Strategy, Planning & Quality Assurance">Strategy, Planning & QA</option>
                        <option value="Audit">Audit</option>
                        <option value="Product & Market Development">Product & Market Development</option>
                        <option value="Resource Center">Resource Center</option>
                        <option value="ICT">ICT</option>
                        <option value="Nation Brand Development">Nation Brand Development</option>
                    </select>
                    <select class="form-select" id="priority-filter" onchange="updateTasksView()">
                        <option value="all">All Priorities</option>
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <option value="Critical">Critical</option>
                    </select>
                    <select class="form-select" id="sort-by" onchange="updateTasksView()">
                        <option value="dueDate-asc">Due Date (Asc)</option>
                        <option value="dueDate-desc">Due Date (Desc)</option>
                        <option value="priority">Priority</option>
                        <option value="createdAt">Creation Date</option>
                    </select>
                </div>
                <div id="my-tasks-list">
                    <!-- Dynamic tasks -->
                </div>
            </div>
        </div>
        
        <!-- Assigned Tasks Page -->
        <div id="assigned" class="page">
            <div class="dashboard-card full-width">
                <h2 class="card-title">📋 Tasks Assigned to Me</h2>
                <div class="filter-group">
                    <input type="text" class="form-input" id="assigned-task-search" placeholder="Search tasks..." oninput="updateAssignedTasksView()">
                    <select class="form-select" id="assigned-filter" onchange="updateAssignedTasksView()">
                        <option value="all">All Tasks</option>
                        <option value="active">Active Tasks</option>
                        <option value="completed">Completed Tasks</option>
                    </select>
                    <select class="form-select" id="assigned-department-filter" onchange="updateAssignedTasksView()">
                        <option value="all">All Departments</option>
                        <option value="Executive">Executive</option>
                        <option value="Strategy, Planning & Quality Assurance">Strategy, Planning & QA</option>
                        <option value="Audit">Audit</option>
                        <option value="Product & Market Development">Product & Market Development</option>
                        <option value="Resource Center">Resource Center</option>
                        <option value="ICT">ICT</option>
                        <option value="Nation Brand Development">Nation Brand Development</option>
                    </select>
                    <select class="form-select" id="assigned-priority-filter" onchange="updateAssignedTasksView()">
                        <option value="all">All Priorities</option>
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <option value="Critical">Critical</option>
                    </select>
                </div>
                <div id="assigned-tasks-notice"></div>
                <div id="assigned-tasks-list">
                    <!-- Dynamic assigned tasks -->
                </div>
            </div>
        </div>
        
        <!-- Create Task Page -->
        <div id="create" class="page">
            <div class="dashboard-card full-width">
                <h2 class="card-title">➕ Create New Task</h2>
                <form id="task-form" onsubmit="createTask(event)">
                    <div class="form-group">
                        <label class="form-label" for="task-title">Task Title*</label>
                        <input type="text" class="form-input" id="task-title" placeholder="Enter task title..." required aria-required="true">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="task-description">Description</label>
                        <textarea class="form-textarea" rows="4" id="task-description" placeholder="Describe the task in detail..."></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label class="form-label" for="task-assignee">Assign To*</label>
                            <select class="form-select" id="task-assignee" required aria-required="true">
                                <option value="">Select assignee...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="task-priority">Priority</label>
                            <select class="form-select" id="task-priority">
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                                <option value="High">High</option>
                                <option value="Critical">Critical</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label class="form-label" for="task-due-date">Due Date</label>
                            <input type="date" class="form-input" id="task-due-date">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="task-department">Department</label>
                            <select class="form-select" id="task-department">
                                <option value="">Select department...</option>
                                <option value="Executive">Executive</option>
                                <option value="Strategy, Planning & Quality Assurance">Strategy, Planning & QA</option>
                                <option value="Audit">Audit</option>
                                <option value="Product & Market Development">Product & Market Development</option>
                                <option value="Resource Center">Resource Center</option>
                                <option value="ICT">ICT</option>
                                <option value="Nation Brand Development">Nation Brand Development</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="task-dependencies">Dependencies</label>
                        <select class="form-select" id="task-dependencies" multiple>
                            <!-- Dynamic task options -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="task-milestone"> Mark as Milestone
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 20px; padding: 12px 24px;">Create Task</button>
                </form>
            </div>
        </div>
        
        <!-- Hierarchy Page -->
        <div id="hierarchy" class="page">
            <div class="hierarchy-view">
                <h2 class="card-title">🏢 Organizational Hierarchy & Task Distribution</h2>
                <div id="hierarchy-content">
                    <!-- Dynamic hierarchy -->
                </div>
            </div>
        </div>
        
        <!-- Performance Page -->
        <div id="performance" class="page">
            <div class="dashboard-card full-width">
                <h2 class="card-title">📈 Performance Overview</h2>
                <div class="filter-group">
                    <select class="form-select" id="performance-user-filter" onchange="updatePerformanceView()">
                        <option value="all">All Users</option>
                    </select>
                    <select class="form-select" id="performance-time-filter" onchange="updatePerformanceView()">
                        <option value="all">All Time</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
                <div id="performance-stats"></div>
                <canvas id="task-trends-chart" style="margin-top: 20px;"></canvas>
            </div>
        </div>
        
        <!-- Help Page -->
        <div id="help" class="page">
            <div class="dashboard-card full-width">
                <h2 class="card-title">❓ Help & Tutorials</h2>
                <div>
                    <h3>Getting Started</h3>
                    <p>Watch this video to learn how to use the KEPROBA Task Management System:</p>
                    <video controls style="width: 100%; max-width: 600px;">
                        <source src="tutorial.mp4" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <h3>FAQs</h3>
                    <details>
                        <summary>How do I create a task?</summary>
                        <p>Go to the "Create Task" page, fill in the required fields, and click "Create Task".</p>
                    </details>
                    <details>
                        <summary>How do I switch users?</summary>
                        <p>Click "Switch User" in the header, select a user from the dropdown, and confirm.</p>
                    </details>
                    <details>
                        <summary>How do I view performance metrics?</summary>
                        <p>Go to the "Performance" page to see task completion rates and department workloads.</p>
                    </details>
                    <details>
                        <summary>How do I add a comment to a task?</summary>
                        <p>Click "Comments" on a task, type your comment, and click "Add" or press Enter.</p>
                    </details>
                </div>
            </div>
        </div>
        
        <!-- Edit Task Modal -->
        <div id="edit-task-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Task</h2>
                    <span class="modal-close" onclick="closeEditModal()">×</span>
                </div>
                <form id="edit-task-form" onsubmit="saveTaskEdit(event)">
                    <input type="hidden" id="edit-task-id">
                    <div class="form-group">
                        <label class="form-label" for="edit-task-title">Task Title*</label>
                        <input type="text" class="form-input" id="edit-task-title" required aria-required="true">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-task-description">Description</label>
                        <textarea class="form-textarea" rows="4" id="edit-task-description"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-task-assignee">Assign To*</label>
                        <select class="form-select" id="edit-task-assignee" required aria-required="true">
                            <option value="">Select assignee...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-task-priority">Priority</label>
                        <select class="form-select" id="edit-task-priority">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-task-due-date">Due Date</label>
                        <input type="date" class="form-input" id="edit-task-due-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-task-department">Department</label>
                        <select class="form-select" id="edit-task-department">
                            <option value="">Select department...</option>
                            <option value="Executive">Executive</option>
                            <option value="Strategy, Planning & Quality Assurance">Strategy, Planning & QA</option>
                            <option value="Audit">Audit</option>
                            <option value="Product & Market Development">Product & Market Development</option>
                            <option value="Resource Center">Resource Center</option>
                            <option value="ICT">ICT</option>
                            <option value="Nation Brand Development">Nation Brand Development</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-task-dependencies">Dependencies</label>
                        <select class="form-select" id="edit-task-dependencies" multiple>
                            <!-- Dynamic task options -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="edit-task-milestone"> Mark as Milestone
                        </label>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Notification -->
        <div id="notification" class="notification"></div>
    </div>
    
    <script>
        // Global state management
        let currentUser = null;
        let tasks = [];
        let taskTrendsChart = null;
        let users = {
            floice_mukabana: {
                name: 'Floice Mukabana',
                role: 'Chief Executive Officer',
                avatar: 'FM',
                level: 0,
                department: 'Executive',
                canAssignTo: [
                    'celestine_rono', 'victor_otieno', 'rebecca_mpaayei', 
                    'reuben_wanjala', 'maureen_mambo', 'austin_macheso'
                ]
            },
            celestine_rono: {
                name: 'Celestine Rono',
                role: 'Strategy Director',
                avatar: 'CR',
                level: 1,
                department: 'Strategy, Planning & Quality Assurance',
                manager: 'floice_mukabana',
                canAssignTo: ['rebecca_mpaayei', 'austin_macheso']
            },
            victor_otieno: {
                name: 'Victor Otieno',
                role: 'Audit Director',
                avatar: 'VO',
                level: 1,
                department: 'Audit',
                manager: 'floice_mukabana',
                canAssignTo: ['mary_wanjiku']
            },
            rebecca_mpaayei: {
                name: 'Rebecca Mpaayei',
                role: 'PMDD Manager',
                avatar: 'RM',
                level: 2,
                department: 'Product & Market Development',
                manager: 'celestine_rono',
                canAssignTo: ['austin_macheso', 'peter_ouma']
            },
            reuben_wanjala: {
                name: 'Reuben Wanjala',
                role: 'Director Resource Center',
                avatar: 'RW',
                level: 1,
                department: 'Resource Center',
                manager: 'floice_mukabana',
                canAssignTo: ['wycliffe_rono']
            },
            wycliffe_rono: {
                name: 'Wycliffe Rono',
                role: 'ICT Manager',
                avatar: 'WR',
                level: 2,
                department: 'ICT',
                manager: 'reuben_wanjala',
                canAssignTo: ['peter_ouma']
            },
            maureen_mambo: {
                name: 'Maureen Mambo',
                role: 'Director Nation Brand Development',
                avatar: 'MM',
                level: 1,
                department: 'Nation Brand Development',
                manager: 'floice_mukabana',
                canAssignTo: ['mary_wanjiku']
            },
            austin_macheso: {
                name: 'Austin Macheso',
                role: 'Product Development Expert',
                avatar: 'AM',
                level: 3,
                department: 'Product & Market Development',
                manager: 'rebecca_mpaayei',
                canAssignTo: ['peter_ouma']
            },
            peter_ouma: {
                name: 'Peter Ouma',
                role: 'Senior Analyst',
                avatar: 'PO',
                level: 4,
                department: 'Product & Market Development',
                manager: 'austin_macheso',
                canAssignTo: ['mary_wanjiku']
            },
            mary_wanjiku: {
                name: 'Mary Wanjiku',
                role: 'Analyst',
                avatar: 'MW',
                level: 5,
                department: 'Product & Market Development',
                manager: 'peter_ouma',
                canAssignTo: []
            }
        };
        
        // Initialize with sample tasks
        function initializeTasks() {
            tasks = [
                {
                    id: 1,
                    title: 'Q4 Export Strategy Development',
                    description: 'Develop comprehensive export strategy for Q4 including market analysis.',
                    creator: 'floice_mukabana',
                    assignee: 'celestine_rono',
                    status: 'in-progress',
                    priority: 'High',
                    dueDate: '2025-12-15',
                    department: 'Strategy, Planning & Quality Assurance',
                    createdAt: new Date('2025-07-01'),
                    comments: [
                        { author: 'celestine_rono', text: 'Started market analysis section', timestamp: new Date() }
                    ],
                    dependencies: [],
                    isMilestone: true
                },
                {
                    id: 2,
                    title: 'Financial Audit Preparation',
                    description: 'Prepare documentation for annual financial audit.',
                    creator: 'floice_mukabana',
                    assignee: 'victor_otieno',
                    status: 'done',
                    priority: 'Critical',
                    dueDate: '2025-07-28',
                    department: 'Audit',
                    createdAt: new Date('2025-07-15'),
                    comments: [],
                    dependencies: [],
                    isMilestone: false
                },
                {
                    id: 3,
                    title: 'Product Market Analysis',
                    description: 'Analyze market opportunities for Made in Kenya products.',
                    creator: 'celestine_rono',
                    assignee: 'rebecca_mpaayei',
                    status: 'not-started',
                    priority: 'Medium',
                    dueDate: '2025-09-10',
                    department: 'Product & Market Development',
                    createdAt: new Date('2025-07-20'),
                    comments: [],
                    dependencies: [1],
                    isMilestone: false
                },
                {
                    id: 4,
                    title: 'ICT System Upgrade',
                    description: 'Upgrade task management system infrastructure.',
                    creator: 'reuben_wanjala',
                    assignee: 'wycliffe_rono',
                    status: 'in-progress',
                    priority: 'High',
                    dueDate: '2025-08-05',
                    department: 'ICT',
                    createdAt: new Date('2025-07-18'),
                    comments: [
                        { author: 'wycliffe_rono', text: 'Completed server assessment', timestamp: new Date() }
                    ],
                    dependencies: [],
                    isMilestone: true
                }
            ];
        }
        
        // Save and load tasks
        function saveTasks() {
            localStorage.setItem('keproba_tasks', JSON.stringify(tasks));
        }
        
        function loadTasks() {
            const savedTasks = localStorage.getItem('keproba_tasks');
            if (savedTasks) {
                tasks = JSON.parse(savedTasks).map(task => ({
                    ...task,
                    createdAt: new Date(task.createdAt),
                    comments: task.comments.map(c => ({ ...c, timestamp: new Date(c.timestamp) })),
                    dependencies: task.dependencies || [],
                    isMilestone: task.isMilestone || false
                }));
            } else {
                initializeTasks();
            }
        }
        
        // Send reminders
        function sendReminder(task) {
            const dueDate = new Date(task.dueDate);
            const now = new Date();
            const oneDayBefore = new Date(dueDate.getTime() - 24 * 60 * 60 * 1000);
            
            if (now >= oneDayBefore && now < dueDate && task.status !== 'done') {
                showNotification(`Reminder: Task "${task.title}" is due on ${formatDate(task.dueDate)}!`, 'warning');
                console.log(`Sending reminder to ${users[task.assignee].name} for task "${task.title}"`);
            }
        }
        
        function checkReminders() {
            tasks.forEach(sendReminder);
        }
        
        // Update user interface
        function updateUserInterface() {
            if (!currentUser) return;
            const user = users[currentUser];
            document.getElementById('current-user-name').textContent = user.name;
            document.getElementById('current-user-role').textContent = user.role;
            document.getElementById('current-user-avatar').textContent = user.avatar;
            
            updateAssigneeOptions();
            updateDependencyOptions();
            updateDashboard();
            updateTasksView();
            updateAssignedTasksView();
            updateHierarchyView();
            updatePerformanceView();
        }
        
        // Initialize login
        function initializeLogin() {
            const userSelect = document.getElementById('login-user');
            userSelect.innerHTML = Object.keys(users)
                .map(id => `<option value="${id}">${users[id].name} (${users[id].role})</option>`)
                .join('');
            document.querySelectorAll('.page:not(#login)').forEach(page => page.classList.remove('active'));
            document.getElementById('login').classList.add('active');
        }
        
        function handleLogin(event) {
            event.preventDefault();
            currentUser = document.getElementById('login-user').value;
            document.getElementById('login').classList.remove('active');
            document.getElementById('dashboard').classList.add('active');
            updateUserInterface();
            showNotification(`Welcome, ${users[currentUser].name}!`, 'success');
        }
        
        // User switching
        function switchUser() {
            document.getElementById('login').classList.add('active');
            document.querySelectorAll('.page:not(#login)').forEach(page => page.classList.remove('active'));
            currentUser = null;
            updateUserInterface();
        }
        
        // Update assignee dropdown options
        function updateAssigneeOptions() {
            const assigneeSelect = document.getElementById('task-assignee');
            const editAssigneeSelect = document.getElementById('edit-task-assignee');
            const user = users[currentUser];
            
            [assigneeSelect, editAssigneeSelect].forEach(select => {
                select.innerHTML = '<option value="">Select assignee...</option>';
                if (user.canAssignTo) {
                    user.canAssignTo.forEach(userId => {
                        const assignee = users[userId];
                        const option = document.createElement('option');
                        option.value = userId;
                        option.textContent = `${assignee.name} - ${assignee.role} (${assignee.department})`;
                        select.appendChild(option);
                    });
                }
            });
        }
        
        // Update dependency dropdown options
        function updateDependencyOptions() {
            const depSelect = document.getElementById('task-dependencies');
            const editDepSelect = document.getElementById('edit-task-dependencies');
            [depSelect, editDepSelect].forEach(select => {
                select.innerHTML = tasks
                    .filter(t => t.creator === currentUser && t.id !== parseInt(select.dataset.taskId || '0'))
                    .map(t => `<option value="${t.id}">${t.title}</option>`)
                    .join('');
            });
        }
        
        // Update dashboard statistics
        function updateDashboard() {
            const filter = document.getElementById('dashboard-filter').value;
            const myTasks = getMyTasks();
            const assignedToMe = getAssignedToMe();
            let allMyTasks = [...myTasks, ...assignedToMe];
            
            const now = new Date();
            if (filter === 'week') {
                const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                allMyTasks = allMyTasks.filter(t => new Date(t.createdAt) >= oneWeekAgo);
            } else if (filter === 'month') {
                const oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                allMyTasks = allMyTasks.filter(t => new Date(t.createdAt) >= oneMonthAgo);
            }
            
            const completed = allMyTasks.filter(t => t.status === 'done').length;
            const inProgress = allMyTasks.filter(t => t.status === 'in-progress').length;
            const notStarted = allMyTasks.filter(t => t.status === 'not-started').length;
            const overdue = allMyTasks.filter(t => new Date(t.dueDate) < now && t.status !== 'done').length;
            
            const statsHTML = `
                <div class="stat-item">
                    <div class="stat-number">${allMyTasks.length}</div>
                    <div class="stat-label">Total Tasks</div>
                </div>
                <div class="stat-item" style="background: linear-gradient(135deg, var(--primary-green), var(--accent-blue));">
                    <div class="stat-number">${completed}</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-item" style="background: linear-gradient(135deg, #fdcb6e, #e17055);">
                    <div class="stat-number">${inProgress}</div>
                    <div class="stat-label">In Progress</div>
                </div>
                <div class="stat-item" style="background: linear-gradient(135deg, var(--primary-red), #e84393);">
                    <div class="stat-number">${overdue}</div>
                    <div class="stat-label">Overdue</div>
                </div>
            `;
            
            document.getElementById('dashboard-stats').innerHTML = statsHTML;
            
            const recentTasks = allMyTasks.slice(0, 3);
            const activitiesHTML = recentTasks.map(task => createTaskHTML(task, true)).join('');
            document.getElementById('recent-activities').innerHTML = activitiesHTML;
        }
        
        // Get tasks created by current user
        function getMyTasks() {
            let myTasks = tasks.filter(task => task.creator === currentUser);
            const filter = document.getElementById('tasks-filter')?.value || 'all';
            const deptFilter = document.getElementById('department-filter')?.value || 'all';
            const priorityFilter = document.getElementById('priority-filter')?.value || 'all';
            const searchQuery = document.getElementById('task-search')?.value.toLowerCase() || '';
            const sortBy = document.getElementById('sort-by')?.value || 'dueDate-asc';
            
            if (filter === 'active') myTasks = myTasks.filter(t => t.status !== 'done');
            else if (filter === 'completed') myTasks = myTasks.filter(t => t.status === 'done');
            if (deptFilter !== 'all') myTasks = myTasks.filter(t => t.department === deptFilter);
            if (priorityFilter !== 'all') myTasks = myTasks.filter(t => t.priority === priorityFilter);
            if (searchQuery) myTasks = myTasks.filter(t => 
                t.title.toLowerCase().includes(searchQuery) || 
                (t.description?.toLowerCase().includes(searchQuery) || false)
            );
            
            myTasks.sort((a, b) => {
                if (sortBy === 'dueDate-asc') return new Date(a.dueDate || '9999-12-31') - new Date(b.dueDate || '9999-12-31');
                if (sortBy === 'dueDate-desc') return new Date(b.dueDate || '9999-12-31') - new Date(a.dueDate || '9999-12-31');
                if (sortBy === 'priority') {
                    const priorities = { Critical: 4, High: 3, Medium: 2, Low: 1 };
                    return priorities[b.priority] - priorities[a.priority];
                }
                if (sortBy === 'createdAt') return new Date(b.createdAt) - new Date(a.createdAt);
                return 0;
            });
            
            return myTasks;
        }
        
        // Get tasks assigned to current user
        function getAssignedToMe() {
            let assignedTasks = tasks.filter(task => task.assignee === currentUser);
            const filter = document.getElementById('assigned-filter')?.value || 'all';
            const deptFilter = document.getElementById('assigned-department-filter')?.value || 'all';
            const priorityFilter = document.getElementById('assigned-priority-filter')?.value || 'all';
            const searchQuery = document.getElementById('assigned-task-search')?.value.toLowerCase() || '';
            
            if (filter === 'active') assignedTasks = assignedTasks.filter(t => t.status !== 'done');
            else if (filter === 'completed') assignedTasks = assignedTasks.filter(t => t.status === 'done');
            if (deptFilter !== 'all') assignedTasks = assignedTasks.filter(t => t.department === deptFilter);
            if (priorityFilter !== 'all') assignedTasks = assignedTasks.filter(t => t.priority === priorityFilter);
            if (searchQuery) assignedTasks = assignedTasks.filter(t => 
                t.title.toLowerCase().includes(searchQuery) || 
                (t.description?.toLowerCase().includes(searchQuery) || false)
            );
            
            return assignedTasks;
        }
        
        // Create task HTML
        function createTaskHTML(task, isPreview = false) {
            const creator = users[task.creator];
            const assignee = users[task.assignee];
            const isMyTask = task.creator === currentUser;
            const isAssignedToMe = task.assignee === currentUser;
            
            let statusClass = `status-${task.status.replace('-', '-')}`;
            let statusText = task.status.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
            
            const progressWidth = task.status === 'done' ? 100 : 
                                task.status === 'completed' ? 80 :
                                task.status === 'in-progress' ? 50 : 0;
            
            return `
                <div class="task-item" data-task-id="${task.id}">
                    <div class="task-header">
                        <div class="task-title">${task.title}${task.isMilestone ? ' ⭐' : ''}</div>
                        <div class="task-status ${statusClass}" onclick="cycleTaskStatus(${task.id})">${statusText}</div>
                    </div>
                    <div class="task-meta">
                        <span>👤 ${isMyTask ? 'Assigned to: ' + assignee.name : 'From: ' + creator.name}</span>
                        <span>📅 Due: ${formatDate(task.dueDate)}</span>
                        <span>⏰ Priority: ${task.priority}</span>
                        <span>🏢 Department: ${task.department || 'None'}</span>
                        ${task.dependencies.length ? `<span>🔗 Depends on: ${task.dependencies.map(id => tasks.find(t => t.id === id)?.title || 'Unknown').join(', ')}</span>` : ''}
                    </div>
                    ${task.description ? `<div style="margin-top: 10px; font-size: 14px; color: var(--primary-black);">${task.description}</div>` : ''}
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressWidth}%;"></div>
                    </div>
                    ${!isPreview ? `
                        <div class="task-actions">
                            ${isAssignedToMe || isMyTask ? `<button class="btn btn-primary" onclick="updateTaskStatus(${task.id}, getNextStatus('${task.status}'))">${getNextStatusText(task.status)}</button>` : ''}
                            ${isMyTask ? `<button class="btn btn-secondary" onclick="editTask(${task.id})">Edit</button>` : ''}
                            <button class="btn btn-secondary" onclick="toggleComments(${task.id})">Comments (${task.comments.length})</button>
                            ${isMyTask ? `<button class="btn btn-warning" onclick="deleteTask(${task.id})">Delete</button>` : ''}
                        </div>
                        <div id="comments-${task.id}" class="task-comments" style="display: none;">
                            ${task.comments.map(comment => `
                                <div class="comment">
                                    <div class="comment-author">${users[comment.author].name}</div>
                                    <div>${comment.text}</div>
                                    <div style="font-size: 12px; color: var(--primary-black); margin-top: 5px;">
                                        ${formatDate(comment.timestamp)} ${new Date(comment.timestamp).toLocaleTimeString()}
                                    </div>
                                </div>
                            `).join('')}
                            <div class="add-comment">
                                <input type="text" class="comment-input" placeholder="Add a comment..." onkeypress="handleCommentKeypress(event, ${task.id})">
                                <button class="btn btn-primary" onclick="addComment(${task.id})">Add</button>
                            </div>
                        </div>` : ''}
                </div>
            `;
        }
        
        // Update tasks view
        function updateTasksView() {
            const myTasks = getMyTasks();
            const tasksHTML = myTasks.length > 0 ? 
                myTasks.map(task => createTaskHTML(task)).join('') :
                '<div style="text-align: center; padding: 40px; color: var(--primary-black);">No tasks created yet. Create your first task!</div>';
            
            document.getElementById('my-tasks-list').innerHTML = tasksHTML;
        }
        
        // Update assigned tasks view
        function updateAssignedTasksView() {
            const assignedTasks = getAssignedToMe();
            const noticeDiv = document.getElementById('assigned-tasks-notice');
            
            if (assignedTasks.length > 0) {
                const pendingTasks = assignedTasks.filter(t => t.status !== 'done');
                if (pendingTasks.length > 0) {
                    noticeDiv.innerHTML = `
                        <div class="task-assignment">
                            <div class="assignment-alert">⚠️ You have ${pendingTasks.length} pending task(s) assigned to you!</div>
                            <div>Please review and update the status of your assigned tasks.</div>
                        </div>
                    `;
                } else {
                    noticeDiv.innerHTML = `
                        <div class="task-assignment" style="background: #d1ecf1; border-color: #bee5eb;">
                            <div class="assignment-alert" style="color: #0c5460;">✅ Great job! All your assigned tasks are completed.</div>
                        </div>
                    `;
                }
            } else {
                noticeDiv.innerHTML = '';
            }
            
            const tasksHTML = assignedTasks.length > 0 ? 
                assignedTasks.map(task => createTaskHTML(task)).join('') :
                '<div style="text-align: center; padding: 40px; color: var(--primary-black);">No tasks assigned to you yet.</div>';
            
            document.getElementById('assigned-tasks-list').innerHTML = tasksHTML;
        }
        
        // Update hierarchy view
        function updateHierarchyView() {
            const hierarchyHTML = `
                <div class="hierarchy-level">
                    <div class="hierarchy-item">
                        <strong>${users.floice_mukabana.name}</strong>
                        <span class="role-indicator">CEO</span>
                        <div style="margin-top: 5px; font-size: 14px; color: var(--primary-black);">
                            Created: ${getTaskCount('floice_mukabana', 'creator')} | Assigned: ${getTaskCount('floice_mukabana', 'assignee')} | Completed: ${getCompletedCount('floice_mukabana')}
                        </div>
                    </div>
                </div>
                <div class="hierarchy-level level-1">
                    <div class="hierarchy-item">
                        <strong>${users.celestine_rono.name}</strong>
                        <span class="role-indicator">Strategy Director</span>
                        <div style="margin-top: 5px; font-size: 14px; color: var(--primary-black);">
                            Created: ${getTaskCount('celestine_rono', 'creator')} | Assigned: ${getTaskCount('celestine_rono', 'assignee')} | Completed: ${getCompletedCount('celestine_rono')}
                        </div>
                    </div>
                    <div class="hierarchy-item">
                        <strong>${users.victor_otieno.name}</strong>
                        <span class="role-indicator">Audit Director</span>
                        <div style="margin-top: 5px; font-size: 14px; color: var(--primary-black);">
                            Created: ${getTaskCount('victor_otieno', 'creator')} | Assigned: ${getTaskCount('victor_otieno', 'assignee')} | Completed: ${getCompletedCount('victor_otieno')}
                        </div>
                    </div>
                    <div class="hierarchy-item">
                        <strong>${users.reuben_wanjala.name}</strong>
                        <span class="role-indicator">Director Resource Center</span>
                        <div style="margin-top: 5px; font-size: 14px; color: var(--primary-black);">
                            Created: ${getTaskCount('reuben_wanjala', 'creator')} | Assigned: ${getTaskCount('reuben_wanjala', 'assignee')} | Completed: ${getCompletedCount('reuben_wanjala')}
                        </div>
                    </div>
                    <div class="hierarchy-item">
                        <strong>${users.maureen_mambo.name}</strong>
                        <span class="role-indicator">Director Nation Brand Development</span>
                        <div style="margin-top: 5px; font-size: 14px; color: var(--primary-black);">
                            Created: ${getTaskCount('maureen_mambo', 'creator')} | Assigned: ${getTaskCount('maureen_mambo', 'assignee')} | Completed: ${getCompletedCount('maureen_mambo')}
                        </div>
                    </div>
                </div>
                <div class="hierarchy-level level-2">
                    <div class="hierarchy-item">
                        <strong>${users.rebecca_mpaayei.name}</strong>
                        <span class="role-indicator">PMDD Manager</span>
                        <div style="margin-top: 5px; font-size: 14px; color: var(--primary-black);">
                            Created: ${getTaskCount('rebecca_mpaayei', 'creator')} | Assigned: ${getTaskCount('rebecca_mpaayei', 'assignee')} | Completed: ${getCompletedCount('rebecca_mpaayei')}
                        </div>
                    </div>
                    <div class="hierarchy-item">
                        <strong>${users.wycliffe_rono.name}</strong>
                        <span class="role-indicator">ICT Manager</span>
                        <div style="margin-top: 5px; font-size: 14px; color: var(--primary-black);">
                            Created: ${getTaskCount('wycliffe_rono', 'creator')} | Assigned: ${getTaskCount('wycliffe_rono', 'assignee')} | Completed: ${getCompletedCount('wycliffe_rono')}
                        </div>
                    </div>
                </div>
                <div class="hierarchy-level level-3">
                    <div class="hierarchy-item">
                        <strong>${users.austin_macheso.name}</strong>
                        <span class="role-indicator">Product Development Expert</span>
                        <div style="margin-top: 5px; font-size: 14px; color: var(--primary-black);">
                            Created: ${getTaskCount('austin_macheso', 'creator')} | Assigned: ${getTaskCount('austin_macheso', 'assignee')} | Completed: ${getCompletedCount('austin_macheso')}
                        </div>
                    </div>
                </div>
                <div class="hierarchy-level level-4">
                    <div class="hierarchy-item">
                        <strong>${users.peter_ouma.name}</strong>
                        <span class="role-indicator">Senior Analyst</span>
                        <div style="margin-top: 5px; font-size: 14px; color: var(--primary-black);">
                            Created: ${getTaskCount('peter_ouma', 'creator')} | Assigned: ${getTaskCount('peter_ouma', 'assignee')} | Completed: ${getCompletedCount('peter_ouma')}
                        </div>
                    </div>
                </div>
                <div class="hierarchy-level level-5">
                    <div class="hierarchy-item">
                        <strong>${users.mary_wanjiku.name}</strong>
                        <span class="role-indicator">Analyst</span>
                        <div style="margin-top: 5px; font-size: 14px; color: var(--primary-black);">
                            Created: ${getTaskCount('mary_wanjiku', 'creator')} | Assigned: ${getTaskCount('mary_wanjiku', 'assignee')} | Completed: ${getCompletedCount('mary_wanjiku')}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('hierarchy-content').innerHTML = hierarchyHTML;
        }
        
        // Update performance view
        function updatePerformanceView() {
            if (users[currentUser].level > 1) {
                showNotification('Access restricted: Managerial role required', 'error');
                showPage('dashboard');
                return;
            }
            
            const userFilter = document.getElementById('performance-user-filter').value;
            const timeFilter = document.getElementById('performance-time-filter').value;
            let filteredTasks = tasks;
            
            if (userFilter !== 'all') {
                filteredTasks = filteredTasks.filter(t => t.assignee === userFilter || t.creator === userFilter);
            }
            
            const now = new Date();
            if (timeFilter === 'week') {
                const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filteredTasks = filteredTasks.filter(t => new Date(t.createdAt) >= oneWeekAgo);
            } else if (timeFilter === 'month') {
                const oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                filteredTasks = filteredTasks.filter(t => new Date(t.createdAt) >= oneMonthAgo);
            }
            
            const completed = filteredTasks.filter(t => t.status === 'done').length;
            const overdue = filteredTasks.filter(t => new Date(t.dueDate) < now && t.status !== 'done').length;
            const completionRate = filteredTasks.length ? (completed / filteredTasks.length * 100).toFixed(1) : 0;
            
            const statsHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number">${filteredTasks.length}</div>
                        <div class="stat-label">Total Tasks</div>
                    </div>
                    <div class="stat-item" style="background: linear-gradient(135deg, var(--primary-green), var(--accent-blue));">
                        <div class="stat-number">${completed}</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-item" style="background: linear-gradient(135deg, var(--primary-red), #e84393);">
                        <div class="stat-number">${overdue}</div>
                        <div class="stat-label">Overdue</div>
                    </div>
                    <div class="stat-item" style="background: linear-gradient(135deg, var(--accent-blue), #0984e3);">
                        <div class="stat-number">${completionRate}%</div>
                        <div class="stat-label">Completion Rate</div>
                    </div>
                </div>
            `;
            
            document.getElementById('performance-stats').innerHTML = statsHTML;
            
            const userSelect = document.getElementById('performance-user-filter');
            userSelect.innerHTML = '<option value="all">All Users</option>' + 
                Object.keys(users)
                    .map(id => `<option value="${id}">${users[id].name} (${users[id].role})</option>`)
                    .join('');
            
            const departments = [
                'Executive', 'Strategy, Planning & Quality Assurance', 'Audit', 
                'Product & Market Development', 'Resource Center', 'ICT', 'Nation Brand Development'
            ];
            const departmentCounts = departments.map(dept => 
                filteredTasks.filter(t => t.department === dept).length
            );
            
            if (taskTrendsChart) taskTrendsChart.destroy();
            
            const ctx = document.getElementById('task-trends-chart').getContext('2d');
            taskTrendsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: departments,
                    datasets: [{
                        label: 'Tasks by Department',
                        data: departmentCounts,
                        backgroundColor: [
                            'var(--primary-green)', 'var(--accent-blue)', 'var(--primary-red)', 
                            '#fdcb6e', '#55a3ff', '#00b894', '#e84393'
                        ],
                        borderColor: [
                            'var(--primary-green)', 'var(--accent-blue)', 'var(--primary-red)', 
                            '#e6b85e', '#4a92e3', '#00a37f', '#d63983'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        // Helper functions
        function getTaskCount(userId, role) {
            return tasks.filter(task => task[role] === userId).length;
        }
        
        function getCompletedCount(userId) {
            return tasks.filter(task => 
                (task.creator === userId || task.assignee === userId) && task.status === 'done'
            ).length;
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'No due date';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        function getNextStatus(currentStatus) {
            const statusFlow = {
                'not-started': 'in-progress',
                'in-progress': 'completed',
                'completed': 'done',
                'done': 'in-progress'
            };
            return statusFlow[currentStatus] || 'in-progress';
        }
        
        function getNextStatusText(currentStatus) {
            const statusTexts = {
                'not-started': 'Start Task',
                'in-progress': 'Mark Complete',
                'completed': 'Mark Done',
                'done': 'Reopen Task'
            };
            return statusTexts[currentStatus] || 'Update Status';
        }
        
        // Task management functions
        function createTask(event) {
            event.preventDefault();
            
            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const assignee = document.getElementById('task-assignee').value;
            const priority = document.getElementById('task-priority').value;
            const dueDate = document.getElementById('task-due-date').value;
            const department = document.getElementById('task-department').value;
            const dependencies = Array.from(document.getElementById('task-dependencies').selectedOptions).map(opt => parseInt(opt.value));
            const isMilestone = document.getElementById('task-milestone').checked;
            
            if (!title || !assignee) {
                showNotification('Please fill in all required fields!', 'error');
                return;
            }
            
            const newTask = {
                id: Date.now(),
                title,
                description,
                creator: currentUser,
                assignee,
                status: 'not-started',
                priority,
                dueDate,
                department,
                createdAt: new Date(),
                comments: [],
                dependencies,
                isMilestone
            };
            
            tasks.push(newTask);
            saveTasks();
            document.getElementById('task-form').reset();
            
            showNotification(`Task "${title}" created and assigned to ${users[assignee].name}!`, 'success');
            console.log(`Sending notification to ${users[assignee].name} about new task assignment`);
            updateUserInterface();
        }
        
        function updateTaskStatus(taskId, newStatus) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                const oldStatus = task.status;
                task.status = newStatus;
                
                const statusChangeComment = {
                    author: currentUser,
                    text: `Status changed from "${oldStatus.replace('-', ' ')}" to "${newStatus.replace('-', ' ')}"`,
                    timestamp: new Date()
                };
                task.comments.push(statusChangeComment);
                
                saveTasks();
                showNotification(`Task status updated to "${newStatus.replace('-', ' ')}"!`, 'success');
                console.log(`Sending notification to ${users[task.creator].name} about status change to ${newStatus}`);
                updateUserInterface();
            }
        }
        
        function cycleTaskStatus(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task && (task.assignee === currentUser || task.creator === currentUser)) {
                if (task.status === 'not-started' && task.dependencies.length) {
                    const incompleteDeps = task.dependencies.filter(depId => {
                        const depTask = tasks.find(t => t.id === depId);
                        return depTask && depTask.status !== 'done';
                    });
                    if (incompleteDeps.length) {
                        showNotification('Cannot start task: complete dependencies first!', 'error');
                        return;
                    }
                }
                const newStatus = getNextStatus(task.status);
                updateTaskStatus(taskId, newStatus);
            }
        }
        
        function addComment(taskId) {
            const task = tasks.find(t => t.id === taskId);
            const commentInput = document.querySelector(`#comments-${taskId} .comment-input`);
            const commentText = commentInput.value.trim();
            
            if (task && commentText) {
                const newComment = {
                    author: currentUser,
                    text: commentText,
                    timestamp: new Date()
                };
                
                task.comments.push(newComment);
                saveTasks();
                commentInput.value = '';
                
                showNotification('Comment added!', 'success');
                updateUserInterface();
            }
        }
        
        function handleCommentKeypress(event, taskId) {
            if (event.key === 'Enter') {
                addComment(taskId);
            }
        }
        
        function toggleComments(taskId) {
            const commentsDiv = document.getElementById(`comments-${taskId}`);
            commentsDiv.style.display = commentsDiv.style.display === 'none' ? 'block' : 'none';
        }
        
        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task && task.creator === currentUser) {
                document.getElementById('edit-task-id').value = task.id;
                document.getElementById('edit-task-title').value = task.title;
                document.getElementById('edit-task-description').value = task.description || '';
                document.getElementById('edit-task-assignee').value = task.assignee;
                document.getElementById('edit-task-priority').value = task.priority;
                document.getElementById('edit-task-due-date').value = task.dueDate || '';
                document.getElementById('edit-task-department').value = task.department || '';
                document.getElementById('edit-task-milestone').checked = task.isMilestone;
                
                const editDepSelect = document.getElementById('edit-task-dependencies');
                editDepSelect.dataset.taskId = task.id;
                updateDependencyOptions();
                Array.from(editDepSelect.options).forEach(opt => {
                    opt.selected = task.dependencies.includes(parseInt(opt.value));
                });
                
                document.getElementById('edit-task-modal').style.display = 'flex';
            }
        }
        
        function saveTaskEdit(event) {
            event.preventDefault();
            
            const taskId = parseInt(document.getElementById('edit-task-id').value);
            const task = tasks.find(t => t.id === taskId);
            if (task && task.creator === currentUser) {
                task.title = document.getElementById('edit-task-title').value;
                task.description = document.getElementById('edit-task-description').value;
                task.assignee = document.getElementById('edit-task-assignee').value;
                task.priority = document.getElementById('edit-task-priority').value;
                task.dueDate = document.getElementById('edit-task-due-date').value;
                task.department = document.getElementById('edit-task-department').value;
                task.dependencies = Array.from(document.getElementById('edit-task-dependencies').selectedOptions).map(opt => parseInt(opt.value));
                task.isMilestone = document.getElementById('edit-task-milestone').checked;
                
                saveTasks();
                closeEditModal();
                showNotification('Task updated!', 'success');
                updateUserInterface();
            }
        }
        
        function closeEditModal() {
            document.getElementById('edit-task-modal').style.display = 'none';
            document.getElementById('edit-task-form').reset();
        }
        
        function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                tasks = tasks.filter(t => t.id !== taskId);
                saveTasks();
                showNotification('Task deleted!', 'success');
                updateUserInterface();
            }
        }
        
        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show', type);
            
            setTimeout(() => {
                notification.classList.remove('show', type);
            }, 3000);
        }